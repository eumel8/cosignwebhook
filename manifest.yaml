---
apiVersion: v1
kind: Service
metadata:
  name: grumpy
  labels:
    app: grumpy
spec:
  ports:
  - name: webhook
    port: 443
    targetPort: 8080
  selector:
    app: grumpy 
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grumpy
  labels:
    app: grumpy
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grumpy
  template:
    metadata:
      name: grumpy 
      labels:
        app: grumpy
    spec:
      containers:
        - name: webhook
          image: mtr.devops.telekom.de/eumel8/grumpy:instance_migration
          imagePullPolicy: Always
          args:
            - -alsologtostderr
            - --log_dir=/
            - -v=10
            - 2>&1
          resources:
            limits:
              memory: 50Mi
              cpu: 300m
            requests:
              memory: 00Mi
              cpu: 300m
          volumeMounts:
            - name: webhook-certs
              mountPath: /etc/certs
              readOnly: true
            - name: logs
              mountPath: /tmp
          securityContext:
            readOnlyRootFilesystem: true
      volumes:
        - name: webhook-certs
          secret:
            secretName: grumpy
        - name: logs
          emptyDir: {}
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: grumpy
webhooks:
  - admissionReviewVersions:
    - v1
    name: grumpy.pipo02mix.org
    clientConfig:
      service:
        name: grumpy
        namespace: grumpy
        path: "/validate"
      caBundle: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUVCVENDQXUwQ0ZBalY5UCtzZ2wrcFBTK3ppQThrbjFCdE9xYkVNQTBHQ1NxR1NJYjNEUUVCRFFVQU1JRysKTVFzd0NRWURWUVFHRXdKRVJURVVNQklHQTFVRUNBd0xRbkpoYm1SbGJtSjFjbWN4RXpBUkJnTlZCQWNNQ2tKeQphV1Z6Wld4aGJtY3hEakFNQmdOVkJCRU1CVEUwTmpVMk1SUXdFZ1lEVlFRSkRBdFRkV1ZrYzNSeUxpQXhNVEVSCk1BOEdBMVVFQ2d3SVpYVnRaV3h1WlhReEZUQVRCZ05WQkFzTURFVjFiV1ZzYm1WMElFbHVZekVVTUJJR0ExVUUKQXd3TFpYVnRaV3h1WlhRdVpHVXhIakFjQmdrcWhraUc5dzBCQ1FFV0QzTnpiRUJsZFcxbGJHNWxkQzVrWlRBZQpGdzB5TWpFeU16QXlNelEyTWpWYUZ3MHlNekF4TWpreU16UTJNalZhTUlHK01Rc3dDUVlEVlFRR0V3SkVSVEVVCk1CSUdBMVVFQ0F3TFFuSmhibVJsYm1KMWNtY3hFekFSQmdOVkJBY01Da0p5YVdWelpXeGhibWN4RGpBTUJnTlYKQkJFTUJURTBOalUyTVJRd0VnWURWUVFKREF0VGRXVmtjM1J5TGlBeE1URVJNQThHQTFVRUNnd0laWFZ0Wld4dQpaWFF4RlRBVEJnTlZCQXNNREVWMWJXVnNibVYwSUVsdVl6RVVNQklHQTFVRUF3d0xaWFZ0Wld4dVpYUXVaR1V4CkhqQWNCZ2txaGtpRzl3MEJDUUVXRDNOemJFQmxkVzFsYkc1bGRDNWtaVENDQVNJd0RRWUpLb1pJaHZjTkFRRUIKQlFBRGdnRVBBRENDQVFvQ2dnRUJBTVhDTkJySXduRWIxeGZpcUM5QjhydDBNTldyajRJZWFLQkU2cUd2WUw0aApnSzFkLzJicjdLb1lSVnNDeUlOczdWQU0weHlBN25VKzV4b09mbk54UE1KYVJENGRRZXpNV0k3R2F2cDNvRmc4CllNNWxxZ2xPQ2RlN3RCcGx1b2VGS2dxMVdPV0xQUzhxcVE4UVFuSUV5VlJReFBiQVNJMDl3Tkd3eDNtQWFmV1IKWkJldVl4QU92K1FKY1FYRTNLNHRmSUpublQxUVdocDJtS1FpRXA3Q2Fkc1VEMnEwZmZtUGZuMllHdjZFWndOcQpnck5DaVhsUi9ydFhFTjUxOVVRcDJ3QmpkRFIxdDRoVi8rdEp3cjZneEdaR2V3eVpFbkFBSjNkazNTZ3h0UlZjClBVNG4xZTd0ZFNvdzQrMjVJSmh5NzRDU011c25nVlBBSUNKZDlYZWJUZjBDQXdFQUFUQU5CZ2txaGtpRzl3MEIKQVEwRkFBT0NBUUVBRUk0bGFCdHlxdkdvdkIrTHRzUmdmenJtb0VwbXJJUjYzeFJtR1kwZ3phYk5qVE1ORzNrVgo2TVdINHhwOFZ4NEJBSnZQNkZGc0NlbFR1Z3Fjd3lKQ1hWbjhIY1N1UUN1aG5IZjVLVUd5TXJMYXJMeGlBaUF2CitsajdLTkYrNmRNZGxkcHNWNVVsaXdxTUlWcVdVdmYrWGx2K3dBdTlNL1BnQlo3RGZ4cTdJVklQMlNmNUU1c0MKZStSbVF4czdWeEQvVmFiOXQvajBCTDVPR1pKR1dzb0dXQ0tsZEt0c3dMcG1IY2tlUEFmMnZyM04rSW9qbVlXQwpoT2s3cmEzdlJ2Z0dyaWZhZmJ2dEpYR0pydm1weUVRY016dzRDZXZ3TmRIelNNTWpBSE1vaDJhRStFREx2QkZUCkdhd2U3c3BWTytCNFN2V05Mem9nRWhJaS9LampwMUdZWEE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg=="
    rules:
      - operations: ["CREATE","UPDATE"]
        apiGroups: [""]
        apiVersions: ["v1"]
        resources: ["pods"]
    failurePolicy: Ignore
    sideEffects: None
